<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1397px" preserveAspectRatio="none" style="width:959px;height:1397px;background:#FFFFFF;" version="1.1" viewBox="0 0 959 1397" width="959px" zoomAndPan="magnify"><defs/><g><rect fill="#DDDDDD" height="1385.8203" style="stroke:#181818;stroke-width:0.5;" width="567" x="248" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="65" x="499" y="18.0669">naivauth</text><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="49" x2="49" y1="89.0234" y2="1324.9297"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="183" x2="183" y1="89.0234" y2="1324.9297"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="309" x2="309" y1="89.0234" y2="1324.9297"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="452" x2="452" y1="89.0234" y2="1324.9297"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="596" x2="596" y1="89.0234" y2="1324.9297"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="737" x2="737" y1="89.0234" y2="1324.9297"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="887" x2="887" y1="89.0234" y2="1324.9297"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="57" x="21" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="28" y="77.7217">Client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="57" x="21" y="1323.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="28" y="1343.9248">Client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="125" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="132" y="77.7217">Reverse proxy</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="125" y="1323.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="132" y="1343.9248">Reverse proxy</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="114" x="252" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="100" x="259" y="77.7217">Auth backend</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="114" x="252" y="1323.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="100" x="259" y="1343.9248">Auth backend</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="411" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="418" y="77.7217">Database</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="411" y="1323.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="418" y="1343.9248">Database</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="116" x="538" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="102" x="545" y="77.7217">Auth frontend</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="116" x="538" y="1323.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="102" x="545" y="1343.9248">Auth frontend</text><rect fill="#E2E2F0" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="147" x="664" y="25.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="691" y="45.1279">Listener on a</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="133" x="671" y="61.4248">pre-authenticated</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="709.5" y="77.7217">channel</text><rect fill="#E2E2F0" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="147" x="664" y="1323.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="691" y="1343.9248">Listener on a</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="133" x="671" y="1360.2217">pre-authenticated</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="709.5" y="1376.5186">channel</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="132" x="821" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="118" x="828" y="77.7217">Web application</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="132" x="821" y="1323.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="118" x="828" y="1343.9248">Web application</text><path d="M5,104.0234 L5,129.0234 L932,129.0234 L932,114.0234 L922,104.0234 L5,104.0234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M922,104.0234 L922,114.0234 L932,114.0234 L922,104.0234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="388.5" y="121.0903">Deny access by default</text><polygon fill="#181818" points="171.5,181.5547,181.5,185.5547,171.5,189.5547,175.5,185.5547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="49.5" x2="177.5" y1="185.5547" y2="185.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="56.5" y="150.2231">Unauthenticated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="56.5" y="165.356">request (no</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="56.5" y="180.4888">session cookie)</text><polygon fill="#181818" points="297,225.8203,307,229.8203,297,233.8203,301,229.8203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183.5" x2="303" y1="229.8203" y2="229.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="190.5" y="209.6216">Authorization</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="190.5" y="224.7544">request</text><polygon fill="#181818" points="194.5,254.9531,184.5,258.9531,194.5,262.9531,190.5,258.9531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="188.5" x2="308" y1="258.9531" y2="258.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="241" y="253.8872">HTTP 401</text><line style="stroke:#181818;stroke-width:2.0;" x1="56.5" x2="66.5" y1="283.0859" y2="293.0859"/><line style="stroke:#181818;stroke-width:2.0;" x1="56.5" x2="66.5" y1="293.0859" y2="283.0859"/><line style="stroke:#181818;stroke-width:1.0;" x1="61.5" x2="182.5" y1="288.0859" y2="288.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="94.5" y="283.02">Deny access</text><path d="M5,301.0859 L5,326.0859 L932,326.0859 L932,311.0859 L922,301.0859 L5,301.0859 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M922,301.0859 L922,311.0859 L932,311.0859 L922,301.0859 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="417.5" y="318.1528">Authenticating</text><polygon fill="#181818" points="584,363.4844,594,367.4844,584,371.4844,588,367.4844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="49.5" x2="590" y1="367.4844" y2="367.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="56.5" y="347.2856">Initial request (non</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="56.5" y="362.4185">authenticated)</text><polygon fill="#181818" points="463,422.8828,453,426.8828,463,430.8828,459,426.8828" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="457" x2="595" y1="426.8828" y2="426.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="116" x="469" y="391.5513">fingerprint (based</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="60" x="469" y="406.6841">on IP and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="57" x="469" y="421.8169">headers)</text><polygon fill="#181818" points="584,482.2813,594,486.2813,584,490.2813,588,486.2813" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="452" x2="590" y1="486.2813" y2="486.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="88" x="459" y="450.9497">cookie, token</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="116" x="459" y="466.0825">(both random and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="49" x="459" y="481.2153">unique)</text><polygon fill="#181818" points="60.5,526.5469,50.5,530.5469,60.5,534.5469,56.5,530.5469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="54.5" x2="595" y1="530.5469" y2="530.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="477" y="510.3481">Set cookie, show</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="477" y="525.481">login token</text><polygon fill="#181818" points="725.5,631.3438,735.5,635.3438,725.5,639.3438,729.5,635.3438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="49.5" x2="731.5" y1="635.3438" y2="635.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="56.5" y="554.6138">Repeat login token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="19" x="56.5" y="569.7466">via</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="56.5" y="584.8794">pre-authenticated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="50" x="56.5" y="600.0122">channel</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="56.5" y="615.145">(telegram, email,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="56.5" y="630.2778">in person)</text><polygon fill="#181818" points="463,690.7422,453,694.7422,463,698.7422,459,694.7422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="457" x2="736.5" y1="694.7422" y2="694.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="106" x="611.5" y="659.4106">mark session as</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="119" x="611.5" y="674.5435">valid, assign to an</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="51" x="611.5" y="689.6763">account</text><path d="M5,707.7422 L5,732.7422 L932,732.7422 L932,717.7422 L922,707.7422 L5,707.7422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M922,707.7422 L922,717.7422 L932,717.7422 L922,707.7422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="359" y="724.8091">Authenticated auth (happy path)</text><polygon fill="#181818" points="171.5,785.2734,181.5,789.2734,171.5,793.2734,175.5,789.2734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="49.5" x2="177.5" y1="789.2734" y2="789.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="56.5" y="753.9419">Initial request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="56.5" y="769.0747">(with session</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="56.5" y="784.2075">cookie)</text><polygon fill="#181818" points="297,829.5391,307,833.5391,297,837.5391,301,833.5391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183.5" x2="303" y1="833.5391" y2="833.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="190.5" y="813.3403">Authorization</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="190.5" y="828.4731">request</text><polygon fill="#181818" points="440,858.6719,450,862.6719,440,866.6719,444,862.6719" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="309" x2="446" y1="862.6719" y2="862.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="119" x="316" y="857.606">fingerprint, cookie</text><polygon fill="#181818" points="320,887.8047,310,891.8047,320,895.8047,316,891.8047" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="314" x2="451" y1="891.8047" y2="891.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="83" x="362" y="886.7388">user account</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="309" x2="351" y1="936.0703" y2="936.0703"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="351" x2="351" y1="936.0703" y2="949.0703"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="310" x2="351" y1="949.0703" y2="949.0703"/><polygon fill="#181818" points="320,945.0703,310,949.0703,320,953.0703,316,949.0703" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="316" y="915.8716">Check access</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="31" x="316" y="931.0044">rules</text><polygon fill="#181818" points="194.5,974.2031,184.5,978.2031,194.5,982.2031,190.5,978.2031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="188.5" x2="308" y1="978.2031" y2="978.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="241" y="973.1372">HTTP 200</text><polygon fill="#181818" points="194.5,1003.3359,184.5,1007.3359,194.5,1011.3359,190.5,1007.3359" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="875,1003.3359,885,1007.3359,875,1011.3359,879,1007.3359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="188.5" x2="881" y1="1007.3359" y2="1007.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="488.75" y="1002.27">Actual request</text><polygon fill="#181818" points="60.5,1047.6016,50.5,1051.6016,60.5,1055.6016,56.5,1051.6016" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="54.5" x2="182.5" y1="1051.6016" y2="1051.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="102.5" y="1031.4028">Application</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="102.5" y="1046.5356">response</text><path d="M5,1064.6016 L5,1089.6016 L932,1089.6016 L932,1074.6016 L922,1064.6016 L5,1064.6016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M922,1064.6016 L922,1074.6016 L932,1074.6016 L922,1064.6016 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="299" x="314.5" y="1081.6685">Authenticated auth (session expired or invalid)</text><polygon fill="#181818" points="171.5,1142.1328,181.5,1146.1328,171.5,1150.1328,175.5,1146.1328" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="49.5" x2="177.5" y1="1146.1328" y2="1146.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="56.5" y="1110.8013">Initial request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="56.5" y="1125.9341">(with session</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="56.5" y="1141.0669">cookie)</text><polygon fill="#181818" points="297,1186.3984,307,1190.3984,297,1194.3984,301,1190.3984" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183.5" x2="303" y1="1190.3984" y2="1190.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="190.5" y="1170.1997">Authorization</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="190.5" y="1185.3325">request</text><polygon fill="#181818" points="440,1215.5313,450,1219.5313,440,1223.5313,444,1219.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="309" x2="446" y1="1219.5313" y2="1219.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="119" x="316" y="1214.4653">fingerprint, cookie</text><polygon fill="#181818" points="320,1244.6641,310,1248.6641,320,1252.6641,316,1248.6641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="314" x2="451" y1="1248.6641" y2="1248.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="31" x="414" y="1243.5981">error</text><polygon fill="#181818" points="194.5,1273.7969,184.5,1277.7969,194.5,1281.7969,190.5,1277.7969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="188.5" x2="308" y1="1277.7969" y2="1277.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="241" y="1272.731">HTTP 403</text><line style="stroke:#181818;stroke-width:2.0;" x1="56.5" x2="66.5" y1="1301.9297" y2="1311.9297"/><line style="stroke:#181818;stroke-width:2.0;" x1="56.5" x2="66.5" y1="1311.9297" y2="1301.9297"/><line style="stroke:#181818;stroke-width:1.0;" x1="61.5" x2="182.5" y1="1306.9297" y2="1306.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="94.5" y="1301.8638">Deny access</text><!--MD5=[357d8005a52d0d7cf9d9fe5dee6f6821]
@startuml
skinparam sequenceMessageAlign direction
skinparam maxMessageSize 120

participant "Client" as client
participant "Reverse proxy" as proxy

box "naivauth"
participant "Auth backend" as backend
participant "Database" as database
participant "Auth frontend" as frontend
participant "Listener on a\npre-authenticated\nchannel" as preauthenticated
end box

participant "Web application" as app

note across: Deny access by default
client -> proxy: Unauthenticated request (no session cookie)
proxy - -> backend: Authorization request
backend - -> proxy: HTTP 401
proxy ->x client: Deny access

note across: Authenticating
client -> frontend: Initial request (non authenticated)
frontend - -> database: //fingerprint (based on IP and headers)//
database - -> frontend: //cookie, token (both random and unique)//
frontend -> client: Set cookie, show login token
client -> preauthenticated: Repeat login token via pre-authenticated channel (telegram, email, in person)
preauthenticated - -> database: //mark session as valid, assign to an account//

note across: Authenticated auth (happy path)
client -> proxy: Initial request (with session cookie)
proxy - -> backend: Authorization request
backend - -> database: //fingerprint, cookie//
database - -> backend: //user account//
backend - -> backend: Check access rules
backend - -> proxy: HTTP 200
proxy <-> app: Actual request
proxy -> client: Application response

note across: Authenticated auth (session expired or invalid)
client -> proxy: Initial request (with session cookie)
proxy - -> backend: Authorization request
backend - -> database: //fingerprint, cookie//
database - -> backend: //error//
backend - -> proxy: HTTP 403
proxy ->x client: Deny access
@enduml

PlantUML version 1.2022.7beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>